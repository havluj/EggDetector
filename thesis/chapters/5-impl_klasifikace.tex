\chapter{Implementace rozpoznávání obrazu}\label{chap:impl_rozpoz}
V této kapitole se zamìøíme na implementaci neuronové sítì, která bude mít za cíl rozpoznat, do které kategorie snímek patøí. Øešíme tedy problém klasifikace obrazu. Kategorií, do kterých budeme chtít snímky rozøadit, bude \textbf{11}:
\begin{description}[labelindent=1cm]
	\item[Kategorie \uv{0}:] Pro snímky, kde je poèet vajec roven \textbf{0}.
	\item[Kategorie \uv{1}:] Pro snímky, kde je poèet vajec roven \textbf{1}.
	\item[Kategorie \uv{2}:] Pro snímky, kde je poèet vajec roven \textbf{2}.
	\item[Kategorie \uv{3}:] Pro snímky, kde je poèet vajec roven \textbf{3}.
	\item[Kategorie \uv{4}:] Pro snímky, kde je poèet vajec roven \textbf{4}.
	\item[Kategorie \uv{5}:] Pro snímky, kde je poèet vajec roven \textbf{5}.
	\item[Kategorie \uv{6}:] Pro snímky, kde je poèet vajec roven \textbf{6}.
	\item[Kategorie \uv{7}:] Pro snímky, kde je poèet vajec roven \textbf{7}.
	\item[Kategorie \uv{8}:] Pro snímky, kde je poèet vajec roven \textbf{8}.
	\item[Kategorie \uv{9}:] Pro snímky, kde je poèet vajec roven \textbf{9}.
	\item[Kategorie \uv{10}:] Pro snímky, kde je poèet vajec roven \textbf{10}.
\end{description}
	
Celé øešení -- pøíprava dat, trénování neuronové sítì, testování funkènosti a mìøení pøesnosti -- budeme implementovat v programovacím jazyce Python 3.

\section{Pøíprava dat}
Abychom nemuseli psát vlastní skripty pro trénování neuronové sítì, ale mohli použít skripty standartnì dostupné~\cite{recog_retrain.py}, musíme upravit strukturu našich dat.

Souèasná struktura našich dat je následující:
\begin{figure}[H]
	\dirtree{%
		.1 hnízdo1.
		.2 záznam1.
		.3 imgdata.xml\DTcomment{informace o poètu vajec v jednotlivých snímcích}.
		.3 snímek1.png.
		.3 snímek2.png.
		.3 ....
		.2 záznam2.
		.3 imgdata.xml\DTcomment{informace o poètu vajec v jednotlivých snímcích.}.
		.3 snímek1.png.
		.3 ....
		.2 ....
		.1 hnízdo2.
		.2 záznam1.
		.3 ....
		.2 ....
		.1 ....
	}
\end{figure}

Nová struktura dat, které potøebujeme docílit:
\begin{figure}[H]
	\dirtree{%
		.1 0\DTcomment{Kategorie \textbf{0}}.
		.2 snímek1.png.
		.2 snímek2.png.
		.2 ....
		.1 1\DTcomment{Kategorie \textbf{1}}.
		.2 snímek1.png.
		.2 ....
		.1 2.
		.2 ....
		.1 3.
		.2 ....
		.1 ....
		.1 9.
		.2 ....
		.1 10.
		.2 ....
	}
\end{figure}
Každá kategorie má vlastní složku. Do každé kategorie patøí snímky s poètem vajec, který odpovídá dané kategorii. Jakmile máme naše trénovací data uspoøádaná do požadované struktury, je vše pøiprano pro trénování neuronové sítì.

\section{Trénování neuronové sítì}
Moderní modely pro rozpoznávání obrazu mají miliony parametrù a je \textbf{extrémnì} výpoèetnì nároèné je vytrénovat. Uèení \uv{pøenosem modelu}\footnote{Transfer learning.} je technika, která ušetøí spoustu práce využitím již pøed-trénovaného modelu a pøetrénováním pouze finálních vrstev~\cite{decaf}. Více informací k efektivitì tohoto øešení viz kapitola \ref{chap:reserse}.

Pøedpokladem pro trénování neuronové sítì je nainstalovaná knihovna TensorFlow a všechny její závislosti~\cite{tensor_install}. Model, ze kterého budeme vycházet je \textbf{Inception-v4}\footnote{Dostupný ke stažení na: \url{http://download.tensorflow.org/models/inception_v4_2016_09_09.tar.gz}}~\cite{inceptionv4}, který byl vytrénován spoleèností Google na pøibližnì 1,2 mil. snímkù\cite{v4trainingsize}. V soutìži ImageNet~\cite{imagenet} drží model Inception-v4 nejlepšího skóre: Top-1 Accuracy\footnote{Odpovìd modelu (ta s nejvyšší pravdìpodobností) pøesnì odpovídala oèekávanému výsledku.} 80.2\% a Top-5 Accuracy\footnote{Kterákoliv z 5 nejpravdìpodobnìjších odpovìdí modelu odpovídala oèekávanému výsledku.} 95.2\%~\cite{imagenetresults}.

Googlem poskytovaný skript pro pøetrénování finálních vrstev nepodporuje model Inception-v4. Staèí však pár modifikací, aby nejnovìjší model podporoval. Upravený skript se nachází v pøíloze \ref{chap:retrain.py}
\begin{lstlisting}[language=bash]
python3 tensorflow/examples/image_retraining/retrain.py \
--bottleneck_dir=egg_recognition/bottlenecks \
--how_many_training_steps=8000 \
--model_dir=egg_recognition/models/ \
--summaries_dir=egg_recognition/training_summaries/ \
--output_graph=egg_recognition/retrained_graph.pb \
--output_labels=egg_recognition/retrained_labels.txt \
--image_dir=egg_recognition/training_data
\end{lstlisting}

\section{Ovìøení funkènosti}
info o spatnych vysledcich

\section{Identifikované problémy}
tøídy jsou moc podobné (obrázek neni zas az tak jiny, jestli tam je jedno nebo dve vajicka)
vetsina casti obrazku neni pro urceni nasi tridy relevantni

kdybychom chteli lepsi vysledky, museli bychom nejak predem oriznout obraz, aby vajicka tvorili vetsinu obrazku